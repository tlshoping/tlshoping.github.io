"use strict"

// const { data } = require("browserslist");

// import natural from 'natural';
// const tokenizer = new natural.WordTokenizer();

let common_json_data;

let userAddress; // Глобальная переменная адреса позозователя
const polygon = [
    [33.07379477829725, 68.8961514694214],
    [33.06352086922949, 68.8966337541839], [33.061460932706694, 68.90111821797765],
    [33.06437917611425, 68.9047978903421], [33.063309244449506, 68.91390537916773],
    [33.058766222049954, 68.91859040762539], [33.04958233838273, 68.91846680843744],
    [33.038945093468975, 68.92694949981988], [33.03328026802964, 68.9295439387003],
    [33.037657633142665, 68.93161309360994], [33.03594101937282, 68.93436137206116],
    [33.02984704049066, 68.93510242217108], [33.03036202462125, 68.93701668625299],
    [33.026671305017736, 68.93852945470164], [33.02967537911387, 68.94677067387805],
    [33.034271378781035, 68.95171129038745], [33.027919907833734, 68.95223579004885],
    [33.04105200317024, 68.96068776652496], [33.05032645271946, 68.96080287624804],
    [33.05453215645506, 68.96203646344554], [33.046721563803615, 68.96536680339383],
    [33.05075560616221, 68.96656930224539], [33.05393134163529, 68.96607597733633],
    [33.0522147278659, 68.97048467624445], [33.06028281258282, 68.97113203313084],
    [33.05818096903533, 68.97329836279646], [33.06264416483619, 68.97369905850438],
    [33.06187168864011, 68.97644208683921], [33.068497312878534, 68.9803696887008],
    [33.06013050356044, 68.98407764339312], [33.06111755647798, 68.98618788426646],
    [33.05450107137095, 68.98810110708897], [33.056131854452296, 68.99079614078111],
    [33.05029536763561, 68.99284414527308], [33.05364276448635, 68.99515369566028],
    [33.057105189725334, 68.99577359180319], [33.05783475057721, 68.99705140257753],
    [33.05440152303817, 68.99726692959656], [33.056075221463935, 68.99919118422102],
    [33.05946553365873, 69.00981003566923], [33.05988752932818, 69.01267675023874],
    [33.06211912722797, 69.01281520497017], [33.064307809784374, 69.0199213744391],
    [33.06482130940447, 69.02281823374717], [33.069713658648084, 69.0234179206245],
    [33.07441288884188, 69.02570119363475], [33.074208787814285, 69.02767649121351],
    [33.07503490819084, 69.02879487682856], [33.08274769396716, 69.02925542438761],
    [33.091202016782105, 69.02851754238148], [33.11450236280922, 69.02309323589309],
    [33.134672574601375, 69.01315769969132], [33.142905063160384, 69.00164634829375],
    [33.15369340277272, 68.9940704860279], [33.16523763037296, 68.99000531441501],
    [33.148843968873805, 68.98424503326488], [33.14274998999177, 68.98298188204949],
    [33.12204333639764, 68.98420652362945], [33.11483107742803, 68.98304879887411],
    [33.1124878714248, 68.98124892830359], [33.113618647307284, 68.98035619308835],
    [33.11499193832268, 68.97962436899832], [33.11580732986343, 68.97849962342076],
    [33.11941637635741, 68.97539595454124], [33.11844005227622, 68.97437886814396],
    [33.11492099404846, 68.97272985536672], [33.11805381417817, 68.9723599663596],
    [33.117817779785184, 68.97170493931058], [33.113204380278844, 68.97188989010121],
    [33.112732311492266, 68.97115007760267], [33.118268390898415, 68.97027151793068],
    [33.120801415210586, 68.96883727108204], [33.12037226176852, 68.96801257233547],
    [33.1179046294745, 68.96726492151092], [33.114990538045184, 68.96559863817556],
    [33.11209375230902, 68.9644115040027], [33.1096261200152, 68.96422649030937],
    [33.10868198244207, 68.96349412916678], [33.11383037599025, 68.96044576674629],
    [33.116324830374246, 68.95917739220299], [33.122225690207536, 68.95740000273047],
    [33.12762984107556, 68.95564075308022], [33.13155659507353, 68.95554820954317],
    [33.132972801433596, 68.95412144743423], [33.13240035962356, 68.95280454834577],
    [33.12649012202149, 68.95124819368644], [33.113385306926354, 68.94635111807698],
    [33.12540160331355, 68.94769352204621], [33.12634574088627, 68.9474312196592],
    [33.12158213767626, 68.94454568712861], [33.120895492168856, 68.94250861340402],
    [33.1380187145198, 68.94232341549687], [33.13737498435628, 68.94034787424131],
    [33.12080966148033, 68.93925198978744], [33.11864508013775, 68.93639638935018],
    [33.125018008757586, 68.93557819314749], [33.12362326006945, 68.93428908653111],
    [33.1213916621692, 68.93144043376255], [33.119345193254176, 68.9287359673486],
    [33.12127638374477, 68.92699086798739], [33.12046178715351, 68.92496237425947],
    [33.12391647236465, 68.92465346429303], [33.12256463902113, 68.92321697607788],
    [33.12258609669326, 68.92215113400363], [33.12179216282462, 68.92188852731921],
    [33.11780103581033, 68.92147916360175], [33.116492117811305, 68.92041323750234],
    [33.10984023945445, 68.92021240507607], [33.10969003574959, 68.91818853006087],
    [33.10775884525868, 68.91804175327404], [33.107518647810174, 68.91488832290207],
    [33.106188272138375, 68.91317303434316], [33.10655305256468, 68.91209851588893],
    [33.10663888325275, 68.91105531895464], [33.108505700727484, 68.90947111074237],
    [33.108162377973265, 68.90865964296086], [33.10830721726005, 68.9066424365834],
    [33.11229834427459, 68.9052047746486], [33.111154710130315, 68.9043730952463],
    [33.10206202156987, 68.90433058070931], [33.101160799340825, 68.90353438424286],
    [33.09767392762136, 68.9037430987165], [33.09666541703186, 68.90270723709999],
    [33.10162213929143, 68.90225886400827], [33.10093549378318, 68.9016790577099],
    [33.09841421730958, 68.90040343023065], [33.09637573845795, 68.8992746316997],
    [33.0979666174218, 68.8964702916636], [33.09804983571644, 68.89468996345309],
    [33.09825067391147, 68.89313306477675], [33.09983854164836, 68.89249114623361],
    [33.103765295646305, 68.89279277293366], [33.110374258658865, 68.89253755060909],
    [33.109709070823214, 68.88934315502482], [33.10237131364138, 68.8869747402925],
    [33.094153025219825, 68.88535011988394], [33.08856028180033, 68.88406505347433],
    [33.08293837170508, 68.88269555806855], [33.08047073941146, 68.88170513560574],
    [33.079590974854725, 68.88146526098569], [33.07594317059464, 68.87857882343431],
    [33.07178038220313, 68.87787456830709], [33.06976336102396, 68.87905089397515],
    [33.068021301396016, 68.88241316948547], [33.06746340192092, 68.88584839717112],
    [33.06321478284134, 68.88820013684533], [33.06847191251052, 68.8921913322582],
    [33.07379477829725, 68.8961514694214]];

let pickupPointsData; // Глобальная переменна точек
let pickupPointsDataSort; // Глобальная переменна отстортированных точек
let url = 'http://tl-shop.icu/'; // Глобальная переменна url
let user_key;
let user_data; // Глобальная переменная данных пользователя
let orders_count;
let basketMainList; // Глобальная переменна корзины пользователя
let basket_products_list = new Object();
let basket_products_id_list = [];
let basket_products_count_list = [];
let secretKey; // Глобальная переменная секретного ключа
let userId;
let bot_id = '251807';
let delivery = 'pickup';
let formData = { // Глобальная переменная формирования заказа
};
let basketUpdateInterval = null; // Глобальная переменна интервала обновления корзины
const days = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота']; // Глобальная переменна названий дней
const months = ['янв', 'фев', 'мар', 'апр', 'мая', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек']; // Глобальная переменна названий месяцев
let selectedPickupPointData; // Глобальная переменная выбранной точки
let userCoords; // Глобальная переменна координат пользователя
let searchController = null; // Глобальная переменна контроллера поиска


function load() {
    let create_orders_loading = document.getElementById('create_orders_loading');
    create_orders_loading.classList.remove('hide');
};

// Функция debounce (задержка вызова)
function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
        clearTimeout(timeoutId); // Сбрасываем предыдущий таймер
        timeoutId = setTimeout(() => {
            func.apply(this, args); // Вызываем функцию после задержки
        }, delay);
    };
}

document.addEventListener('DOMContentLoaded', function () {
    Telegram.WebApp.expand();
    const postData = {
        bot_id: 0,
    };
    const urlParams = new URLSearchParams(window.location.search);
    secretKey = urlParams.get('secret_key'); // Получить значение параметра "param1"
    let myHeaders = new Headers();
    myHeaders.append('Content-Type', 'application/json');
    fetch('https://tl-shop.click/api/V2/get-pickup-points', {
        method: 'POST',
        headers: myHeaders,
        body: JSON.stringify(postData),
    }).then((data) => {
        return data.json();
    }).then((json_data) => {
        pickupPointsData = json_data.data
        get_user(json_data.data);
    });
});
